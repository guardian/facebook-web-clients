var guardian=window.guardian||{};guardian.facebook=guardian.facebook||{};if(typeof console=="undefined"){var console={};console.log=console.error=console.info=console.debug=console.warn=console.trace=console.dir=console.dirxml=console.group=console.groupEnd=console.time=console.timeEnd=console.assert=console.profile=function(){}}(function(e){typeof define=="function"?define(e):typeof YUI=="function"?YUI.add("es5",e):e()})(function(){function e(){}function A(e){return e=+e,e!==e?e=0:e!==0&&e!==1/0&&e!==-1/0&&(e=(e>0||-1)*Math.floor(Math.abs(e))),e}function O(e){var t=typeof e;return e===null||t==="undefined"||t==="boolean"||t==="number"||t==="string"}function M(e){var t,n,r;if(O(e))return e;n=e.valueOf;if(typeof n=="function"){t=n.call(e);if(O(t))return t}r=e.toString;if(typeof r=="function"){t=r.call(e);if(O(t))return t}throw new TypeError}Function.prototype.bind||(Function.prototype.bind=function(n){var r=this;if(typeof r!="function")throw new TypeError("Function.prototype.bind called on incompatible "+r);var s=i.call(arguments,1),o=function(){if(this instanceof o){var e=r.apply(this,s.concat(i.call(arguments)));return Object(e)===e?e:this}return r.apply(n,s.concat(i.call(arguments)))};return r.prototype&&(e.prototype=r.prototype,o.prototype=new e,e.prototype=null),o});var t=Function.prototype.call,n=Array.prototype,r=Object.prototype,i=n.slice,s=t.bind(r.toString),o=t.bind(r.hasOwnProperty),u,a,f,l,c;if(c=o(r,"__defineGetter__"))u=t.bind(r.__defineGetter__),a=t.bind(r.__defineSetter__),f=t.bind(r.__lookupGetter__),l=t.bind(r.__lookupSetter__);if([1,2].splice(0).length!=2){var h=Array.prototype.splice;Array.prototype.splice=function(e,t){return arguments.length?h.apply(this,[e===void 0?0:e,t===void 0?this.length-e:t].concat(i.call(arguments,2))):[]}}if([].unshift(0)!=1){var p=Array.prototype.unshift;Array.prototype.unshift=function(){return p.apply(this,arguments),this.length}}Array.isArray||(Array.isArray=function(t){return s(t)=="[object Array]"});var d=Object("a"),v=d[0]!="a"||!(0 in d);Array.prototype.forEach||(Array.prototype.forEach=function(t){var n=_(this),r=v&&s(this)=="[object String]"?this.split(""):n,i=arguments[1],o=-1,u=r.length>>>0;if(s(t)!="[object Function]")throw new TypeError;while(++o<u)o in r&&t.call(i,r[o],o,n)}),Array.prototype.map||(Array.prototype.map=function(t){var n=_(this),r=v&&s(this)=="[object String]"?this.split(""):n,i=r.length>>>0,o=Array(i),u=arguments[1];if(s(t)!="[object Function]")throw new TypeError(t+" is not a function");for(var a=0;a<i;a++)a in r&&(o[a]=t.call(u,r[a],a,n));return o}),Array.prototype.filter||(Array.prototype.filter=function(t){var n=_(this),r=v&&s(this)=="[object String]"?this.split(""):n,i=r.length>>>0,o=[],u,a=arguments[1];if(s(t)!="[object Function]")throw new TypeError(t+" is not a function");for(var f=0;f<i;f++)f in r&&(u=r[f],t.call(a,u,f,n)&&o.push(u));return o}),Array.prototype.every||(Array.prototype.every=function(t){var n=_(this),r=v&&s(this)=="[object String]"?this.split(""):n,i=r.length>>>0,o=arguments[1];if(s(t)!="[object Function]")throw new TypeError(t+" is not a function");for(var u=0;u<i;u++)if(u in r&&!t.call(o,r[u],u,n))return!1;return!0}),Array.prototype.some||(Array.prototype.some=function(t){var n=_(this),r=v&&s(this)=="[object String]"?this.split(""):n,i=r.length>>>0,o=arguments[1];if(s(t)!="[object Function]")throw new TypeError(t+" is not a function");for(var u=0;u<i;u++)if(u in r&&t.call(o,r[u],u,n))return!0;return!1}),Array.prototype.reduce||(Array.prototype.reduce=function(t){var n=_(this),r=v&&s(this)=="[object String]"?this.split(""):n,i=r.length>>>0;if(s(t)!="[object Function]")throw new TypeError(t+" is not a function");if(!i&&arguments.length==1)throw new TypeError("reduce of empty array with no initial value");var o=0,u;if(arguments.length>=2)u=arguments[1];else do{if(o in r){u=r[o++];break}if(++o>=i)throw new TypeError("reduce of empty array with no initial value")}while(!0);for(;o<i;o++)o in r&&(u=t.call(void 0,u,r[o],o,n));return u}),Array.prototype.reduceRight||(Array.prototype.reduceRight=function(t){var n=_(this),r=v&&s(this)=="[object String]"?this.split(""):n,i=r.length>>>0;if(s(t)!="[object Function]")throw new TypeError(t+" is not a function");if(!i&&arguments.length==1)throw new TypeError("reduceRight of empty array with no initial value");var o,u=i-1;if(arguments.length>=2)o=arguments[1];else do{if(u in r){o=r[u--];break}if(--u<0)throw new TypeError("reduceRight of empty array with no initial value")}while(!0);do u in this&&(o=t.call(void 0,o,r[u],u,n));while(u--);return o});if(!Array.prototype.indexOf||[0,1].indexOf(1,2)!=-1)Array.prototype.indexOf=function(t){var n=v&&s(this)=="[object String]"?this.split(""):_(this),r=n.length>>>0;if(!r)return-1;var i=0;arguments.length>1&&(i=A(arguments[1])),i=i>=0?i:Math.max(0,r+i);for(;i<r;i++)if(i in n&&n[i]===t)return i;return-1};if(!Array.prototype.lastIndexOf||[0,1].lastIndexOf(0,-3)!=-1)Array.prototype.lastIndexOf=function(t){var n=v&&s(this)=="[object String]"?this.split(""):_(this),r=n.length>>>0;if(!r)return-1;var i=r-1;arguments.length>1&&(i=Math.min(i,A(arguments[1]))),i=i>=0?i:r-Math.abs(i);for(;i>=0;i--)if(i in n&&t===n[i])return i;return-1};if(!Object.keys){var m=!0,g=["toString","toLocaleString","valueOf","hasOwnProperty","isPrototypeOf","propertyIsEnumerable","constructor"],y=g.length;for(var b in{toString:null})m=!1;Object.keys=function D(e){if(typeof e!="object"&&typeof e!="function"||e===null)throw new TypeError("Object.keys called on a non-object");var D=[];for(var t in e)o(e,t)&&D.push(t);if(m)for(var n=0,r=y;n<r;n++){var i=g[n];o(e,i)&&D.push(i)}return D}}var w=-621987552e5,E="-000001";if(!Date.prototype.toISOString||(new Date(w)).toISOString().indexOf(E)===-1)Date.prototype.toISOString=function(){var t,n,r,i,s;if(!isFinite(this))throw new RangeError("Date.prototype.toISOString called on non-finite value.");i=this.getUTCFullYear(),s=this.getUTCMonth(),i+=Math.floor(s/12),s=(s%12+12)%12,t=[s+1,this.getUTCDate(),this.getUTCHours(),this.getUTCMinutes(),this.getUTCSeconds()],i=(i<0?"-":i>9999?"+":"")+("00000"+Math.abs(i)).slice(0<=i&&i<=9999?-4:-6),n=t.length;while(n--)r=t[n],r<10&&(t[n]="0"+r);return i+"-"+t.slice(0,2).join("-")+"T"+t.slice(2).join(":")+"."+("000"+this.getUTCMilliseconds()).slice(-3)+"Z"};var S=!1;try{S=Date.prototype.toJSON&&(new Date(NaN)).toJSON()===null&&(new Date(w)).toJSON().indexOf(E)!==-1&&Date.prototype.toJSON.call({toISOString:function(){return!0}})}catch(x){}S||(Date.prototype.toJSON=function(t){var n=Object(this),r=M(n),i;if(typeof r=="number"&&!isFinite(r))return null;i=n.toISOString;if(typeof i!="function")throw new TypeError("toISOString property is not callable");return i.call(n)});if(!Date.parse||"Date.parse is buggy")Date=function(e){function t(n,r,i,s,o,u,a){var f=arguments.length;if(this instanceof e){var l=f==1&&String(n)===n?new e(t.parse(n)):f>=7?new e(n,r,i,s,o,u,a):f>=6?new e(n,r,i,s,o,u):f>=5?new e(n,r,i,s,o):f>=4?new e(n,r,i,s):f>=3?new e(n,r,i):f>=2?new e(n,r):f>=1?new e(n):new e;return l.constructor=t,l}return e.apply(this,arguments)}function i(e,t){var n=t>1?1:0;return r[t]+Math.floor((e-1969+n)/4)-Math.floor((e-1901+n)/100)+Math.floor((e-1601+n)/400)+365*(e-1970)}var n=new RegExp("^(\\d{4}|[+-]\\d{6})(?:-(\\d{2})(?:-(\\d{2})(?:T(\\d{2}):(\\d{2})(?::(\\d{2})(?:\\.(\\d{3}))?)?(Z|(?:([-+])(\\d{2}):(\\d{2})))?)?)?)?$"),r=[0,31,59,90,120,151,181,212,243,273,304,334,365];for(var s in e)t[s]=e[s];return t.now=e.now,t.UTC=e.UTC,t.prototype=e.prototype,t.prototype.constructor=t,t.parse=function(r){var s=n.exec(r);if(s){var o=Number(s[1]),u=Number(s[2]||1)-1,a=Number(s[3]||1)-1,f=Number(s[4]||0),l=Number(s[5]||0),c=Number(s[6]||0),h=Number(s[7]||0),p=!s[4]||s[8]?0:Number(new e(1970,0)),d=s[9]==="-"?1:-1,v=Number(s[10]||0),m=Number(s[11]||0),g;if(f<(l>0||c>0||h>0?24:25)&&l<60&&c<60&&h<1e3&&u>-1&&u<12&&v<24&&m<60&&a>-1&&a<i(o,u+1)-i(o,u)){g=((i(o,u)+a)*24+f+v*d)*60,g=((g+l+m*d)*60+c)*1e3+h+p;if(-864e13<=g&&g<=864e13)return g}return NaN}return e.parse.apply(this,arguments)},t}(Date);Date.now||(Date.now=function(){return(new Date).getTime()});if("0".split(void 0,0).length){var T=String.prototype.split;String.prototype.split=function(e,t){return e===void 0&&t===0?[]:T.apply(this,arguments)}}if("".substr&&"0b".substr(-1)!=="b"){var N=String.prototype.substr;String.prototype.substr=function(e,t){return N.call(this,e<0?(e=this.length+e)<0?0:e:e,t)}}var C="	\n\f\r   ᠎             　\u2028\u2029﻿";if(!String.prototype.trim||C.trim()){C="["+C+"]";var k=new RegExp("^"+C+C+"*"),L=new RegExp(C+C+"*$");String.prototype.trim=function(){if(this===undefined||this===null)throw new TypeError("can't convert "+this+" to object");return String(this).replace(k,"").replace(L,"")}}var _=function(e){if(e==null)throw new TypeError("can't convert "+e+" to object");return Object(e)}}),function(e){"use strict";function t(){}function i(e,t){if(r)return t.indexOf(e);var n=t.length;while(n--)if(t[n]===e)return n;return-1}var n=t.prototype,r=Array.prototype.indexOf?!0:!1;n.getListeners=function(e){var t=this._events||(this._events={});return t[e]||(t[e]=[])},n.addListener=function(e,t){var n=this.getListeners(e);return i(t,n)===-1&&n.push(t),this},n.on=n.addListener,n.removeListener=function(e,t){var n=this.getListeners(e),r=i(t,n);return r!==-1&&(n.splice(r,1),n.length===0&&(this._events[e]=null)),this},n.off=n.removeListener,n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if(typeof t=="object")for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&(typeof i=="function"?s.call(this,r,i):o.call(this,r,i));else{r=n.length;while(r--)s.call(this,t,n[r])}return this},n.removeEvent=function(e){return e?this._events[e]=null:this._events=null,this},n.emitEvent=function(e,t){var n=this.getListeners(e),r=n.length,i;while(r--)i=t?n[r].apply(null,t):n[r](),i===!0&&this.removeListener(e,n[r]);return this},n.trigger=n.emitEvent,e.EventEmitter=t}(this),function(){function e(e){var n,r,i,s;for(n=0,r=t.length;n<r;n++){i=t[n];if(e>=i.n)return s=e/i.n,s.toFixed(s<10?1:0)+i.abbr}return e}var t=[{abbr:"M",n:1e6},{abbr:"K",n:1e3}];guardian.facebook.BigNumberFormatter=e}(),function(){function e(e,t,n){this.model=e,this.view=t,this.authorizer=n}function t(e){return function(t){t.error?console.error(t.error.message):e(t.data)}}e.prototype.baseURI=null,e.prototype.model=null,e.prototype.view=null,e.prototype.authorizer=null,e.prototype.initialise=function(e){this.baseURI=e,this.authorizer.onNotAuthorized.then(this.handleNotAuthorized.bind(this)),this.authorizer.onConnected.then(this.checkExistingVote.bind(this)),this.authorizer.onConnected.then(this.submitVoteWhenLoggedIn.bind(this)),this.view.on("voted",this.submitVote.bind(this)),jQuery.ajax({url:this.baseURI+"/poll?type="+this.model.type,dataType:"jsonp",jsonpCallback:"votecontroller",data:{article:this.getArticleId()}}).then(t(this.handleLoadedData.bind(this)))},e.prototype.handleNotAuthorized=function(){this.model.setAllowedToVote(!0)},e.prototype.handleLoadedData=function(e){this.model.setAllData(e.questions[0])},e.prototype.getArticleId=function(){return jQuery("meta[property='og:url']").attr("content")},e.prototype.checkExistingVote=function(){jQuery.ajax({url:this.baseURI+"/user",type:"GET",dataType:"jsonp",jsonpCallback:"votecontroller",data:{article:this.getArticleId(),user:this.authorizer.userId}}).then(t(this.handleUserExistingVote.bind(this)))},e.prototype.handleUserExistingVote=function(e){e.choice?(console.log("Controller: User has already voted for "+e.choice),this.model.registerVote(e.choice,!1)):(console.log("Controller: User has not voted yet"),this.model.setAllowedToVote(!0))},e.prototype.submitVote=function(e){this.choice=e,this.authorizer.login().then(this.submitVoteWhenLoggedIn.bind(this))},e.prototype.submitVoteWhenLoggedIn=function(){this.choice&&jQuery.ajax({url:this.baseURI+"/vote",dataType:"jsonp",jsonpCallback:"votecontroller",data:{article:this.getArticleId(),access_token:this.authorizer.accessToken,user:this.authorizer.userId,action:this.choice}}).then(t(this.handlePostResponse.bind(this,this.choice))),this.choice=null},e.prototype.handlePostResponse=function(e,t){console.log("Controller: Posted response to Facebook OK. Voted for "+e),this.model.registerVote(e,!0)},guardian.facebook.VoteController=e}(),function(){function e(e,t,n){this.jContainer=jQuery(e);if(!this.jContainer.length)throw new Error("Login button view has no element: "+e);this.authorizer=t,this.model=n,this.render(),this.model.on(guardian.facebook.VoteModel.DATA_CHANGED,this.render.bind(this)),this.authorizer.getLoginStatus().then(this.render.bind(this)),this.authorizer.onUserDataLoaded.then(this.render.bind(this)),this.jContainer.delegate("a","click.loginbutton",this.handleLoginClick.bind(this))}e.prototype.model=null,e.prototype.authorizer=null,e.prototype.jContainer=null,e.prototype.render=function(){var e=this.authorizer.userData;if(e){var t=e.first_name,n=this.model.getVotelabel();n?t+=", your vote '"+n+"' was counted":t+=", share your opinion with your friends on Facebook",this.jContainer.find(".message").html(t),e.username&&this.jContainer.find(".avatar").removeClass("initially-off").attr("src","http://graph.facebook.com/"+e.username+"/picture")}else this.jContainer.find(".message").html("<a>Share your opinion with your friends on Facebook</a>")},e.prototype.handleLoginClick=function(){return console.log("Auth'ing user"),this.authorizer.login(),!1},guardian.facebook.LoginButtonView=e}(),function(){function e(e,t){this.jContainer=jQuery(e);if(!this.jContainer.length)throw new Error("Title view has no element: "+e);this.model=t,this.render()}e.prototype.model=null,e.prototype.jContainer=null,e.getAuthors=function(){return jQuery("a.contributor").map(function(){return jQuery(this).text()}).get()},e.prototype.render=function(){var t="";switch(this.model.type){case guardian.facebook.VoteModel.AGREE_WITH_OPINION:t="Do you agree with "+e.getAuthors().join(" and ")+"?";break;case guardian.facebook.VoteModel.AGREE_WITH_HEADLINE:t="Do you agree?"}this.jContainer.html(t)},guardian.facebook.TitleView=e}(),function(){function e(e){this.type=e,this.choice=undefined,this.allowedToVote=!0,this.dataDeferred=jQuery.Deferred()}e.prototype=Object.create(EventEmitter.prototype),e.prototype.type=null,e.prototype.questionId=null,e.prototype.options=null,e.prototype.choice=null,e.prototype.allowedToVote=null,e.prototype.setAllData=function(t){this.answers=t.answers,this.trigger(e.DATA_CHANGED),this.dataDeferred.resolve()},e.prototype.whenDataIsSet=function(){return this.dataDeferred.promise()},e.prototype.setAllowedToVote=function(t){this.allowedToVote=t,this.trigger(e.DATA_CHANGED)},e.prototype.getAgree=function(){return this.answers&&this.answers[0].count},e.prototype.getDisagree=function(){return this.answers&&this.answers[1].count},e.prototype.getTotal=function(){return this.getAgree()+this.getDisagree()},e.prototype.getAnswerById=function(e){return this.answers.filter(function(t){return t.id==e})[0]},e.prototype.registerVote=function(t,n){this.whenDataIsSet().then(function(){var r=this.getAnswerById(t);r?(n===undefined||n===!0?(console.log("Model: Registering new vote: "+t),r.count++):console.log("Model: Noticing existing vote: "+t),this.choice=t,this.trigger(e.DATA_CHANGED)):console.log("Unrecognised vote: "+t)}.bind(this))},e.prototype.getVotelabel=function(){return this.choice?this.getAnswerById(this.choice).label:undefined},e.prototype.canVote=function(){return!this.choice&&this.allowedToVote},e.prototype.getAgreePercent=function(){var t=this.getTotal();return t?this.getAgree()/t*100:e.EVEN},e.prototype.destroy=function(){this.removeEvent()},e.DATA_CHANGED="dataChanged",e.EVEN=50,e.AGREE_WITH_OPINION="agree_with_opinion",e.AGREE_WITH_HEADLINE="agree_with_headline",e.THINK_LIKELY="think_headline_likely",guardian.facebook.VoteModel=e}(),function(){function e(e,t,n,r){this.jContainer=jQuery(e).removeClass("initially-off"),this.model=t,this.numberFormatter=r,this.initialise(n)}e.prototype=Object.create(EventEmitter.prototype),e.prototype.jContainer=null,e.prototype.donut=null,e.prototype.numberFormatter=null,e.prototype.model=null,e.prototype.initialise=function(t){this.jContainer.html(e.HTML),this.renderCallback=this.render.bind(this),this.model.on("dataChanged",this.renderCallback),this.donut=new t(this.jContainer.find(".donut-container")),this.jContainer.delegate(".btn:not(.disabled)","click.vote-component",this.handleButtonClick.bind(this))},e.prototype.updateButton=function(e,t,n){var r=e[t],i=jQuery(n);i.attr("data-action",r.id),i.find(".count").html(this.numberFormatter(r.count)),i.find(".label").html(r.label),this.model.choice?(i.removeClass("btn"),r.id==this.model.choice?i.addClass("selected"):i.addClass("disabled")):i.addClass("btn")},e.prototype.render=function(){this.donut.setPercent(this.model.getAgreePercent()),this.jContainer.find(".choice").each(this.updateButton.bind(this,this.model.answers)),this.animated||(this.animated=!0,jQuery(".vote-component").animate({height:"180px"}))},e.prototype.handleButtonClick=function(e){var t=jQuery(e.currentTarget),n=t.data("action");this.model.canVote()&&(t.find(".label").text("Sharing..."),this.trigger("voted",[n]))},e.prototype.destroy=function(){this.model.removeEvent("dataChanged",this.renderCallback),this.jContainer.undelegate(".vote-component")},e.HTML='<div class="vote-component"><strong class="vote-title"></strong><div class="social-summary"><img class="avatar initially-off" /><img class="facebookIcon" src="http://facebook-web-clients.appspot.com/static/facebookIcon_16x16.gif" /><div class="message"></div></div><div class="vote-area"><span class="choice agree btn zone-primary-background" data-action="agree"><span class="tick">&#10004;</span><span class="label"></span><span class="count zone-primary-background"></span></span><div class="donut-container"></div><span class="choice disagree btn zone-secondary-background" data-action="disagree"><span class="count zone-secondary-background"></span><span class="label"></span><span class="tick">&#10004;</span></span></div></div>',guardian.facebook.VoteComponent=e}();