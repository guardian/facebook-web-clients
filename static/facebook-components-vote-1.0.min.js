var guardian=window.guardian||{};guardian.facebook=guardian.facebook||{};if(typeof console=="undefined"){var console={};console.log=console.error=console.info=console.debug=console.warn=console.trace=console.dir=console.dirxml=console.group=console.groupEnd=console.time=console.timeEnd=console.assert=console.profile=function(){}}(function(e){"use strict";function t(){}function i(e,t){if(r)return t.indexOf(e);var n=t.length;while(n--)if(t[n]===e)return n;return-1}var n=t.prototype,r=Array.prototype.indexOf?!0:!1;n.getListeners=function(e){var t=this._events||(this._events={});return t[e]||(t[e]=[])},n.addListener=function(e,t){var n=this.getListeners(e);return i(t,n)===-1&&n.push(t),this},n.on=n.addListener,n.removeListener=function(e,t){var n=this.getListeners(e),r=i(t,n);return r!==-1&&(n.splice(r,1),n.length===0&&(this._events[e]=null)),this},n.off=n.removeListener,n.addListeners=function(e,t){return this.manipulateListeners(!1,e,t)},n.removeListeners=function(e,t){return this.manipulateListeners(!0,e,t)},n.manipulateListeners=function(e,t,n){var r,i,s=e?this.removeListener:this.addListener,o=e?this.removeListeners:this.addListeners;if(typeof t=="object")for(r in t)t.hasOwnProperty(r)&&(i=t[r])&&(typeof i=="function"?s.call(this,r,i):o.call(this,r,i));else{r=n.length;while(r--)s.call(this,t,n[r])}return this},n.removeEvent=function(e){return e?this._events[e]=null:this._events=null,this},n.emitEvent=function(e,t){var n=this.getListeners(e),r=n.length,i;while(r--)i=t?n[r].apply(null,t):n[r](),i===!0&&this.removeListener(e,n[r]);return this},n.trigger=n.emitEvent,e.EventEmitter=t})(this),function(){function e(e){var n,r,i,s;for(n=0,r=t.length;n<r;n++){i=t[n];if(e>=i.n)return s=e/i.n,s.toFixed(s<10?1:0)+i.abbr}return e}var t=[{abbr:"M",n:1e6},{abbr:"K",n:1e3}];guardian.facebook.BigNumberFormatter=e}(),function(){function e(e,t,n){this.model=e,this.view=t,this.authorizer=n}function t(e){return function(t){t.error?console.error(t.error.message):e(t.data)}}e.prototype.model=null,e.prototype.view=null,e.prototype.authorizer=null,e.prototype.initialise=function(e){this.baseURI=e,this.authorizer.onNotAuthorized.then(this.handleNotAuthorized.bind(this)),this.authorizer.onConnected.then(this.checkExistingVote.bind(this)),this.authorizer.onConnected.then(this.submitVoteWhenLoggedIn.bind(this)),this.view.on("voted",this.submitVote.bind(this)),jQuery.ajax({url:this.baseURI+"/poll",dataType:"jsonp",data:{article:this.getArticleId()}}).then(t(this.handleLoadedData.bind(this)))},e.prototype.handleNotAuthorized=function(){console.log("Controller: User is not authorized to use app, but showing buttons"),this.model.setAllowedToVote(!0)},e.prototype.handleLoadedData=function(e){console.log(e),this.model.setAllData(e.questions[0])},e.prototype.getArticleId=function(){return jQuery("meta[property='og:url']").attr("content")},e.prototype.checkExistingVote=function(){console.log("Controller: Checking for existing votes  on user "+this.authorizer.userId),jQuery.ajax({url:this.baseURI+"/user",type:"GET",dataType:"jsonp",data:{article:this.getArticleId(),user:this.authorizer.userId}}).then(t(this.handleUserExistingVote.bind(this)))},e.prototype.handleUserExistingVote=function(e){e.choice?(console.log("Controller: User has already voted for "+e.choice),this.model.registerVote(e.choice,!1)):(console.log("Controller: User has not voted yet"),this.model.setAllowedToVote(!0))},e.prototype.submitVote=function(e){this.choice=e,this.authorizer.login().then(this.submitVoteWhenLoggedIn.bind(this))},e.prototype.submitVoteWhenLoggedIn=function(){this.choice&&jQuery.ajax({url:this.baseURI+"/vote",dataType:"jsonp",data:{article:this.getArticleId(),access_token:this.authorizer.accessToken,user:this.authorizer.userId,action:this.choice}}).then(t(this.handlePostResponse.bind(this,this.choice))),this.choice=null},e.prototype.handlePostResponse=function(e,t){console.log("Controller: Posted response to Facebook OK. Voted for "+e),this.model.registerVote(e,!0)},e.APP_NAMESPACE="theguardian-spike",guardian.facebook.VoteController=e}(),function(){function e(e,t,n){this.jContainer=jQuery(e),this.authorizer=t,this.model=n,this.render(),this.model.on(guardian.facebook.VoteModel.DATA_CHANGED,this.render.bind(this)),this.authorizer.getLoginStatus().then(this.render.bind(this)),this.authorizer.onUserDataLoaded.then(this.render.bind(this)),this.jContainer.delegate("a","click.loginbutton",this.handleLoginClick.bind(this))}e.prototype.model=null,e.prototype.authorizer=null,e.prototype.jContainer=null,e.prototype.render=function(){var e=this.authorizer.userData;if(e){var t=e.first_name,n=this.model.getVotelabel();n?t+=", your vote '"+n+"' was counted":t+=", share your opinion with your friends on Facebook",this.jContainer.find(".message").html(t),e.username&&this.jContainer.find(".avatar").removeClass("initially-off").attr("src","http://graph.facebook.com/"+e.username+"/picture")}else this.jContainer.find(".message").html("<a>Share your opinion with your friends on Facebook</a>")},e.prototype.handleLoginClick=function(){return console.log("Auth'ing user"),this.authorizer.login(),!1},guardian.facebook.LoginButtonView=e}(),function(){function e(){this.choice=undefined,this.allowedToVote=!0,this.dataDeferred=jQuery.Deferred()}e.prototype=Object.create(EventEmitter.prototype),e.prototype.questionId=null,e.prototype.options=null,e.prototype.choice=null,e.prototype.allowedToVote=null,e.prototype.setAllData=function(t){this.answers=t.answers,this.trigger(e.DATA_CHANGED),this.dataDeferred.resolve()},e.prototype.whenDataIsSet=function(){return this.dataDeferred.promise()},e.prototype.setAllowedToVote=function(t){this.allowedToVote=t,this.trigger(e.DATA_CHANGED)},e.prototype.getAgree=function(){return this.answers&&this.answers[0].count},e.prototype.getDisagree=function(){return this.answers&&this.answers[1].count},e.prototype.getTotal=function(){return this.getAgree()+this.getDisagree()},e.prototype.getAnswerById=function(e){return this.answers.filter(function(t){return t.id==e})[0]},e.prototype.registerVote=function(t,n){this.whenDataIsSet().then(function(){var r=this.getAnswerById(t);r?(n===undefined||n===!0?(console.log("Model: Registering new vote: "+t),r.count++):console.log("Model: Noticing existing vote: "+t),this.choice=t,this.trigger(e.DATA_CHANGED)):console.log("Unrecognised vote: "+t)}.bind(this))},e.prototype.getVotelabel=function(){return this.choice?this.getAnswerById(this.choice).label:undefined},e.prototype.canVote=function(){return!this.choice&&this.allowedToVote},e.prototype.getAgreePercent=function(){var t=this.getTotal();return t?this.getAgree()/t*100:e.EVEN},e.prototype.destroy=function(){this.removeEvent()},e.DATA_CHANGED="dataChanged",e.EVEN=50,guardian.facebook.VoteModel=e}(),function(){function e(e,t,n,r){this.jContainer=jQuery(e).removeClass("initially-off"),this.model=t,this.numberFormatter=r,this.initialise(n)}e.prototype=Object.create(EventEmitter.prototype),e.prototype.jContainer=null,e.prototype.donut=null,e.prototype.numberFormatter=null,e.prototype.model=null,e.prototype.initialise=function(t){this.jContainer.html(e.HTML),this.renderCallback=this.render.bind(this),this.model.on("dataChanged",this.renderCallback),this.donut=new t(this.jContainer.find(".donut-container")),this.jContainer.delegate(".btn:not(.disabled)","click.vote-component",this.handleButtonClick.bind(this))},e.prototype.updateButton=function(e,t,n){var r=e[t],i=jQuery(n);i.attr("data-action",r.id),i.find(".count").html(this.numberFormatter(r.count)),i.find(".label").html(r.label),this.model.choice?(i.removeClass("btn"),r.id==this.model.choice?i.addClass("selected"):i.addClass("disabled")):i.addClass("btn")},e.prototype.render=function(){this.donut.setPercent(this.model.getAgreePercent()),this.jContainer.find(".choice").each(this.updateButton.bind(this,this.model.answers)),this.animated||(this.animated=!0,jQuery(".vote-component").animate({height:"180px"}))},e.prototype.handleButtonClick=function(e){var t=jQuery(e.currentTarget),n=t.data("action");this.model.canVote()&&(t.find(".label").text("Voting..."),this.trigger("voted",[n]))},e.prototype.destroy=function(){this.model.removeEvent("dataChanged",this.renderCallback),this.jContainer.undelegate(".vote-component")},e.HTML='<div class="vote-component"><div class="social-summary"><img class="avatar initially-off" /><img class="facebookIcon" src="http://facebook-web-clients.appspot.com/static/facebookIcon_16x16.gif" /><div class="message"></div></div><div class="vote-area"><span class="choice agree btn zone-primary-background" data-action="agree"><span class="tick">&#10004;</span><span class="label"></span><span class="count zone-primary-background"></span></span><div class="donut-container"></div><span class="choice disagree btn zone-secondary-background" data-action="disagree"><span class="count zone-secondary-background"></span><span class="label"></span><span class="tick">&#10004;</span></span></div></div>',guardian.facebook.VoteComponent=e}();